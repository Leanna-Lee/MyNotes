# 网卡单双 NUMA 导致网络性能下降  
## 测试场景  
在两台 KVM 宿主机上各部署多台虚拟机，在虚拟机之间使用 iperf3 进行一对一跨宿主机打流测试。
在测试中发现，3对 VM 在跨宿主机打流时每组网络带宽可达到940Mbps（接近限速1Gbps）；当 VM 数量增加到某一数值时，每组网络带宽突降，甚至低于100Mbps。　　 
## 问题原因
- 在没有 NUMA 影响的情况下，多对 VM 跨宿主机网络测试性能正常，每组带宽接近限速1Gbps；  
- 当有 NUMA 影响时，物理网口 bond 时使用了不同 NUMA Node 所对应的网卡。跨 NUMA Node 内存访问的高延迟导致发送时的锁同步竞争代价急剧增大，使得网口发送成为瓶颈，进而拉低每组 VM 之间的网络打流性能。
## 调试分析
系统性能出现问题，可能包括以下几个方面：
- CPU 长时间被占用运行，检查是否有 CPU 占用过高的瓶颈点；
- CPU 经常要等待运行，检查是否有很多任务处于待运行状态，进程调度代价过高；
- CPU 访存出现缓存未命中（Cache Miss）或者换页（Page Swap），导致高出一两个数量级的延迟；
- 
　
