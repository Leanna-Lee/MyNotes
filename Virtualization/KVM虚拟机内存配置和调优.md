# KVM 虚拟机内存配置和调优
宿主机的内存压缩主要采用 KSM（Kernel SamePage Merging）技术。  
- **COW**  
Copy on write：写时复制。  
一种计算机程序设计领域的优化策略。其核心思想是，如果有多个调用者（callers）同时请求相同资源（如内存或磁盘上的数据存储），他们会共同获取相同的指针指向相同的资源，直到某个调用者试图修改资源的内容时，系统才会真正复制一份专用副本（private copy）给该调用者，而其他调用者所见到的最初的资源仍然保持不变。这过程对其他的调用者都是透明的（transparently）。优点是如果调用者没有修改该资源，就不会有副本（private copy）被建立，因此多个调用者只是读取操作时可以共享同一份资源。  
- **KSM**
Kernel SamePage Merging。KSM 让内核扫描正在运行中的所有程序，并比较它们的内存，如果发现它们的内存页有相同的，那么就把它们相同的内存页合并为一个内存页，并将其标识为“写时复制”，当标识为“写时复制”的内存页需要被修改时，内核就为其分配新的内存空间，并复制内存页到新的空间，在新的内存空间上进行修改。  
KSM 设计初衷就是为了给虚拟化节约内存的，因为如果虚拟机都使用相同的系统和运行类似的程序，那么每个虚拟机进程就会有很大一部分的内存页是相同的，这时候使用 KSM 技术就能大大降低内存的使用率，也方便 KVM 内存的过载使用。传说有人在16G内存的机器上，成功运行 52 个 1G 内存的 XP 虚拟机。  
**缺点：**  
（1）KSM 需要扫描相同的内存页，会消耗一定的计算机资源用于内存扫描，加重 CPU 的开销；  
（2）使用 KSM 还需要保证足够的内存交换空间，因为我们把多个内存页合并为一个，当内存耗尽，而恰好有内存页需要修改时，此时内存就溢出了，只能是频繁地使用 swap 交互，导致虚拟机性能下降严重。
## 1、宿主机内存合并（压缩）
KSM 在 CentOS6、CentOS7上是默认打开的。